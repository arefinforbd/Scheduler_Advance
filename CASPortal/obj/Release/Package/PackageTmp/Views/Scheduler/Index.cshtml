
@{
    ViewBag.Title = "Scheduler";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .row{
        margin-left:0px;
    }

    #tblDate tr th {
        text-align: right;
        padding-right: 10px;
    }

    table#tblDate,
    table#tblTime {
        width: 800px;
        height: 300px;
        border: 1px solid #CCCCCC;
    }

    table#tblDate {
        color: #3e92e2;
        font-size: 13px;
        border-top-left-radius: 10px;
    }

    tr.timeheader th {
        height: 40px;
        text-align: center;
        background-color: #fcf6af;
    }

    table#tblTime td.tdTime {
        width: 30px;
        height: 50px;
    }

    table#tblTime td.td00 {
        border-right: 1px dotted #FF0000;
    }

    table#tblTime td.td00:hover {
        background-color: #ffd571;
        cursor: pointer;
    }

    table#tblTime td.td30:hover {
        background-color: #aad7fe;
        cursor: pointer;
    }

    .col-lg-1,
    .col-lg-11{
        padding:0px;
    }

    .modal.in .modal-dialog {
        transform: translate3d(-630px, 50px, 0px);
    }
    
    .ui-widget {
        font-size: 1em;
    }
    
    #txtStartTime {
        width: 135px;
    }

    #txtEndTime {
        width: 140px;
    }

    .occupied {
        width: 30px;
        color: #ffffff;
        text-align: center;
        font-weight: bold;
        cursor: not-allowed;
    }

    .selected{
        background-color: #808080;
    }
</style>

<h2>Index</h2>

<div id="page-wrapper">
    <br/>
    <p><label>Date : <input class="form-control input-sm" id="datepicker" placeholder="Click to select"></label></p>

    <div class="row">
        <div class="col-lg-1">
            <table border="1" cellspacing="5" cellpadding="5" id="tblDate"></table>
        </div>

        <div class="col-lg-11"> 
            <table border="2" cellspacing="5" cellpadding="5" id="tblTime" class="table-hover table"></table>
        </div>
    </div>

    <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" id="myModal" class="modal fade" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h4 id="myModalLabel" class="modal-title">Add Schedule</h4>
                </div>
                <div class="modal-body">
                    <label>Subject: <input class="form-control input-sm"></label><br/>
                    <label>Date: <input id="txtDate" class="form-control input-sm"></label>
                    <br />
                    <div class="row">
                        <label>Time Start: <input id="txtStartTime" class="form-control input-sm"></label>
                        <label>Time End: <input id="txtEndTime" class="form-control input-sm"></label>
                        <button id="btnAddHour" class="btn btn-default btn-sm" type="button" style="margin-top: 45px;">Add Hour</button>
                    </div>
                    <br />
                    <label>Description: <textarea class="form-control" rows="3" cols="50"></textarea></label>
                    <input type="hidden" id="hdncombid" />
                    <input type="hidden" id="hdncombidend" />
                </div>
                <div class="modal-footer">
                    <button data-dismiss="modal" id="btnSave" class="btn btn-primary" type="button">Save Schedule</button>
                    <button data-dismiss="modal" class="btn btn-default" type="button">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    var _hours = 0;
    var _minhours = "7:00";
    var _maxhours = "18:00";

    $(function () {

        var isMouseDown = false;

        generateTimes();
        generateDays(new Date());
        $(document).tooltip();

        $("#datepicker").val("");

        $("#tblTime td").mousedown(function () {
            isMouseDown = true;
        }).mouseover(function () {
            if (isMouseDown) {
                $(this).css("cursor", "col-resize");
                //$("#hdncombidend").val($(this).attr("combid"));
            }
        });

        $("#datepicker").datepicker({
            dateFormat: "dd MM, yy",
            showOtherMonths: true,
            selectOtherMonths: true,
            altFormat: "yy-mm-dd",
            onSelect: function (date) {
                generateDays($(this).datepicker('getDate'));
                generateTimes();
            }
        });
    });

    function AddHour() {
        var chkHour = 0;
        var hour = 0;
        var ttime = $("#txtEndTime").val();
        var lst = ttime.indexOf(":");
        var fst = ttime.substring(0, lst);

        if (ttime.indexOf(":30") > 0) {
            hour = parseInt(fst) + 1;
            hour = hour + ":00";
            chkHour = parseInt(ttime.replace(":", ""));
            if (chkHour >= parseInt(_maxhours.replace(":", ""))) {
                hour = _maxhours;
                _hours -= 10;
                alert("Schedule cannot be set after " + _maxhours);
            }
        }
        else {
            hour = ttime.replace(":00", ":30");
            chkHour = parseInt(ttime.replace(":", ""));
            if (chkHour >= parseInt(_maxhours.replace(":", ""))) {
                hour = _maxhours;
                _hours -= 10;
                alert("Schedule cannot be set after " + _maxhours);
            }
        }

        return hour;
    }

    $("#btnAddHour").click(function () {
        var combid = $("#hdncombid").val();
        _hours += 10;
        combid = parseInt(combid.replace("id", "")) + _hours;
        $("#hdncombidend").val("id" + combid);
        $("#txtEndTime").val(AddHour());
    });

    $("#btnSave").click(function () {
        var combid = $("#hdncombid").val();
        var combidend = $("#hdncombidend").val();

        var startindex = parseInt(combid.replace("id", ""));
        var endindex = parseInt(combidend.replace("id", ""));

        endindex = isNaN(endindex) ? startindex : endindex;

        for (var index = startindex; index <= endindex; index += 10) {
            $("#tblTime").find('[combid="id' + index + '"]').css("background-color", "#808080")
            $("#tblTime").find('[combid="id' + index + '"]').removeAttr("data-target");
            $("#tblTime").find('[combid="id' + index + '"]').removeAttr("class");
            $("#tblTime").find('[combid="id' + index + '"]').html("N/A");
            $("#tblTime").find('[combid="id' + index + '"]').addClass("occupied");
            $("#tblTime").find('[combid="id' + index + '"]').css("vertical-align", "middle");
        }
        _hours = 0;
        $("#hdncombid").val("");
        $("#hdncombidend").val("");
    });

    function SelectedDate(row)
    {
        var dateval;
        var caldate = $("#datepicker").datepicker('getDate');
        if (caldate == null)
            caldate = new Date();

        var dayparam = caldate;
        var time = parseInt(row);

        dateval = new Date(dayparam.setDate(caldate.getDate() + time))
        return FormatDate(dateval);
    }

    $(document.body).on('click', '#tblTime td.td00', function (event) {

        _hours = 0;
        $("#hdncombidend").val("");

        var idval = $(this).attr("id");
        var caldate = $("#datepicker").datepicker('getDate');
        idval = idval.replace("id", "");

        var hour = parseInt(idval);
        hour = hour - 1;
        hour = hour / 2;
        hour = hour + 8;
        /*if (hour > 12)
            hour = hour - 12;*/

        $("#txtDate").val(SelectedDate($(this).attr("row")));
        $("#txtStartTime").val(hour + ":00");
        $("#txtEndTime").val(hour + ":30");
        $("#hdncombid").val($(this).attr("combid"));
    });

    $(document.body).on('click', '#tblTime td.td30', function (event) {

        _hours = 0;
        $("#hdncombidend").val("");

        var idval = $(this).attr("id");
        idval = idval.replace("id", "");

        var hour = parseInt(idval);
        hour = hour / 2;
        hour = hour + 7;
        /*if (hour > 12)
            hour = hour - 12;*/

        $("#txtDate").val(SelectedDate($(this).attr("row")));
        $("#txtStartTime").val(hour + ":30");

        /*if (hour >= 12)
            hour = hour - 12;*/

        $("#txtEndTime").val((hour + 1) + ":00");
        $("#hdncombid").val($(this).attr("combid"));
    });

    function generateTimes() {

        var title = "";
        var timeval;
        var index = 0;
        var html = '<thead><tr class="timeheader">';

        for (index = 8; index <= 17; index++) {
            //html += '<th colspan="2">' + (index > 12 ? (index-12) : (index)) + '</th>';
            html += '<th colspan="2">' + index + ':00</th>';
        }

        html += '</tr></thead>';
        html += '<tbody>';

        for (var tr = 1; tr <= 5; tr++) {
            html += '<tr>';
            for (var td = 1; td <= 20; td++) {
                if (td % 2 > 0) {
                    title = (Math.round(td / 2) + 7) + ":00-" + (Math.round(td / 2) + 7) + ":30";
                    html += '<td title="' + title + '" combid="id' + td + tr + '" id="id' + td + '" row="' + tr + '" data-target="#myModal" data-toggle="modal" class="tdTime td00"></td>';
                }
                else {
                    title = (Math.round(td / 2) + 7) + ":30-" + (Math.round(td / 2) + 8) + ":00";
                    html += '<td title="' + title + '" combid="id' + td + tr + '" id="id' + td + '" row="' + tr + '" data-target="#myModal" data-toggle="modal" class="tdTime td30"></td>';
                }
            }
            html += '</tr>';
        }
        html += '</tbody>';

        $("#tblTime").html(html);
    }

    function generateDays(day) {

        var dateval;
        var index = 0;
        var dayparam = day;
        var html = '<thead><tr class="timeheader"><th></th></tr>';

        for (index = 1; index <= 5; index++) {
            dateval = new Date(dayparam.setDate(day.getDate() + 1))
            html += '<tr><th>' + FormatDate(dateval) + '</th></tr>';
        }
        html += '</thead>';

        $("#tblDate").html(html);
    }

    function FormatDate(datevalue) {
        var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        var yyyy = datevalue.getFullYear().toString();
        var mm = monthNames[datevalue.getMonth()];
        var dd = datevalue.getDate().toString();

        //return (dd[1] ? dd : "0" + dd[0]) + "-" + (mm[1] ? mm : "0" + mm[0]) + "-" + yyyy;
        return (dd[1] ? dd : "0" + dd[0]) + "-" + mm + "-" + yyyy;
    }

</script>